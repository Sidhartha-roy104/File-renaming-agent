import os
import subprocess
from datetime import datetime

def get_txt_metadata(filepath):
    """Extract metadata from a text file"""
    stats = os.stat(filepath)
    
    # Get file metadata
    metadata = {
        "filename": os.path.basename(filepath),
        "full_path": filepath,
        "size_bytes": stats.st_size,
        "size_kb": round(stats.st_size / 1024, 2),
        "created": datetime.fromtimestamp(stats.st_ctime).strftime('%Y-%m-%d %H:%M:%S'),
        "modified": datetime.fromtimestamp(stats.st_mtime).strftime('%Y-%m-%d %H:%M:%S'),
        "accessed": datetime.fromtimestamp(stats.st_atime).strftime('%Y-%m-%d %H:%M:%S'),
    }
    
    # Read first few lines of content
    try:
        with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
            content = f.read(500)  # First 500 characters
            metadata["preview"] = content
            metadata["line_count"] = len(f.readlines()) + content.count('\n')
    except:
        metadata["preview"] = "Could not read content"
        metadata["line_count"] = 0
    
    return metadata

def ask_ollama(prompt):
    """Send prompt to Ollama"""
    process = subprocess.Popen(
        ["ollama", "run", "llama3"],
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True,
        encoding="utf-8"
    )
    stdout, _ = process.communicate(prompt)
    return stdout.strip()

def analyze_metadata(filepath):
    """Main function to analyze file metadata"""
    print("\nüìÅ Extracting metadata...\n")
    
    metadata = get_txt_metadata(filepath)
    
    # Display metadata
    print("=" * 60)
    print("FILE METADATA:")
    print("=" * 60)
    for key, value in metadata.items():
        if key != "preview":
            print(f"{key.upper()}: {value}")
    print("=" * 60)
    
    # Create prompt for Ollama
    prompt = f"""
Analyze this text file metadata and provide insights:

Filename: {metadata['filename']}
Size: {metadata['size_kb']} KB
Created: {metadata['created']}
Last Modified: {metadata['modified']}
Last Accessed: {metadata['accessed']}

Content Preview:
\"\"\"
{metadata['preview']}
\"\"\"

Based on this metadata, answer:
1. What type of document is this likely to be?
2. Is this file actively being used or is it old/abandoned?
3. What can you infer about the content?
4. Any recommendations for organizing or naming this file?

Keep your response concise and clear.
"""
    
    print("\nüß† Sending to Ollama for analysis...\n")
    
    response = ask_ollama(prompt)
    
    print("=" * 60)
    print("OLLAMA ANALYSIS:")
    print("=" * 60)
    print(response)
    print("=" * 60)

if __name__ == "__main__":
    filepath = input("Enter path to .txt file: ").strip()
    
    if not os.path.isfile(filepath):
        print("‚ùå File not found!")
    elif not filepath.lower().endswith('.txt'):
        print("‚ùå Please provide a .txt file!")
    else:
        analyze_metadata(filepath)
        print("\n‚úÖ Analysis complete!")